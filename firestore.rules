rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isFarmer() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'farmer';
    }
    
    function isDealer() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'dealer';
    }
    
    function isConnected(farmerId, dealerId) {
      return farmerId in get(/databases/$(database)/documents/users/$(dealerId)).data.connectedFarmers &&
             dealerId in get(/databases/$(database)/documents/users/$(farmerId)).data.connectedDealers;
    }

    // users/{userId}
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow write: if isOwner(userId) || isAdmin();
    }

    // batches/{batchId}
    match /batches/{batchId} {
      allow read, write: if isOwner(get(/databases/$(database)/documents/batches/$(batchId)).data.farmerUID) || isAdmin();
    }

    // batches/{batchId}/dailyRecords/{recordId}
    match /batches/{batchId}/dailyRecords/{recordId} {
      allow read, write: if isOwner(get(/databases/$(database)/documents/batches/$(batchId)).data.farmerUID) || isAdmin();
    }

    // inventory/{itemId} - Farmer's inventory
    match /inventory/{itemId} {
      allow read, write: if isOwner(get(/databases/$(database)/documents/inventory/$(itemId)).data.farmerUID) || isAdmin();
    }

    // dealerInventory/{itemId}
    match /dealerInventory/{itemId} {
      allow read: if isAdmin() || (isFarmer() && get(/databases/$(database)/documents/dealerInventory/$(itemId)).data.dealerUID in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.connectedDealers);
      allow write: if isOwner(get(/databases/$(database)/documents/dealerInventory/$(itemId)).data.dealerUID) || isAdmin();
    }

    // orders/{orderId}
    match /orders/{orderId} {
      allow create: if (isOwner(request.resource.data.farmerUID) && isFarmer() && isConnected(request.resource.data.farmerUID, request.resource.data.dealerUID)) || isAdmin();
      allow update, read: if (isOwner(resource.data.farmerUID) || isOwner(resource.data.dealerUID)) || isAdmin();
    }
    
    // ledger/{entryId}
    match /ledger/{entryId} {
        allow read: if isOwner(get(/databases/$(database)/documents/ledger/$(entryId)).data.userId) || isAdmin();
        allow create: if isOwner(request.resource.data.userId) || isAdmin();
    }
    
    // dailyRates/{date}
    match /dailyRates/{date} {
        allow read: if request.auth != null; // Allow any authenticated user to read
        allow write: if isAdmin();
    }

    // connections/{connectionId}
    match /connections/{connectionId} {
        allow read, write: if (isOwner(resource.data.farmerUID) || isOwner(resource.data.dealerUID)) || isAdmin();
        allow create: if (isOwner(request.resource.data.farmerUID) && isFarmer()) || (isOwner(request.resource.data.dealerUID) && isDealer()) || isAdmin();
    }
    
    // audit_logs/{logId}
    match /audit_logs/{logId} {
      allow read, list, write: if isAdmin();
    }
  }
}
