rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Function to check if a user has an admin role
    function isAdmin() {
      return getUserData(request.auth.uid).role == 'admin';
    }

    // Function to get a user's data document
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }
    
    // Function to check if a farmer is connected to a dealer
    function isConnected(farmerId, dealerId) {
      return dealerId in getUserData(farmerId).connectedDealers;
    }

    // users: Only the owner or an admin can read/write their own data.
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if request.auth.uid == userId || isAdmin();
    }
    
    // batches: Only the owner farmer can manage their batches.
    match /batches/{batchId} {
      allow read, write, delete: if request.auth.uid == get(/databases/$(database)/documents/batches/$(batchId)).data.farmerUID || isAdmin();
      
      // dailyRecords: Only the owner of the parent batch can manage daily records.
      match /dailyRecords/{recordId} {
        allow read, write, delete: if request.auth.uid == get(/databases/$(database)/documents/batches/$(batchId)).data.farmerUID || isAdmin();
      }
    }
    
    // inventory (farmer): A user can only manage their own inventory items.
    match /inventory/{itemId} {
      allow read, write: if request.auth.uid == resource.data.farmerUID;
      allow create: if request.auth.uid == request.resource.data.farmerUID;
    }
    
    // dealerInventory: Only the owner dealer can write. A farmer can read only if connected. Admins can read all.
    match /dealerInventory/{itemId} {
      allow read: if request.auth.uid == resource.data.dealerUID 
                  || isConnected(request.auth.uid, resource.data.dealerUID)
                  || isAdmin();
      allow write: if request.auth.uid == resource.data.dealerUID || isAdmin();
      allow create: if request.auth.uid == request.resource.data.dealerUID || isAdmin();
    }
    
    // orders: Farmers can create orders for dealers they are connected to. Dealers/Farmers can update status.
    match /orders/{orderId} {
      // Create: Farmer must be the one creating the order and must be connected to the dealer.
      allow create: if request.auth.uid == request.resource.data.farmerUID &&
                       isConnected(request.resource.data.farmerUID, request.resource.data.dealerUID) &&
                       exists(/databases/$(database)/documents/dealerInventory/$(request.resource.data.productId)) &&
                       get(/databases/$(database)/documents/dealerInventory/$(request.resource.data.productId)).data.dealerUID == request.resource.data.dealerUID;
                       
      // Read: Only the involved farmer, dealer, or an admin can read.
      allow read: if request.auth.uid == resource.data.farmerUID 
                  || request.auth.uid == resource.data.dealerUID 
                  || isAdmin();
                  
      // Update: Only the dealer can approve/reject.
      allow update: if (request.auth.uid == resource.data.dealerUID || isAdmin()) &&
                       request.resource.data.status in ['Approved', 'Rejected'];
    }
    
    // ledger: A user can only write to their own ledger. Admins can write to any for corrections.
    match /ledger/{entryId} {
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth.uid == request.resource.data.userId || isAdmin();
      // No updates or deletes allowed to maintain financial integrity.
      allow update, delete: if false;
    }
    
    // dailyRates: Publicly readable for premium users, but only writable by admins.
    match /dailyRates/{rateId} {
      allow read: if getUserData(request.auth.uid).planType == 'premium' || isAdmin();
      allow write: if isAdmin();
    }

    // connections: Users can initiate, and receivers can update.
    match /connections/{connectionId} {
      allow read: if request.auth.uid == resource.data.farmerUID || request.auth.uid == resource.data.dealerUID || isAdmin();
      allow create: if request.auth.uid == request.resource.data.farmerUID || request.auth.uid == request.resource.data.dealerUID;
      allow update: if (request.auth.uid == resource.data.dealerUID && resource.data.requestedBy == 'farmer') || 
                       (request.auth.uid == resource.data.farmerUID && resource.data.requestedBy == 'dealer');
    }
    
    // audit_logs: Only admins can read or write.
    match /audit_logs/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
